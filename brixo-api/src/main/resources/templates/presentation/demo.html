<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo — Brixo Proyector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            cursor: none
        }

        .layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease
        }

        #slide-layer {
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000
        }

        #slide-layer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain
        }

        #iframe-layer {
            z-index: 2;
            opacity: 0;
            pointer-events: none
        }

        #iframe-layer.active {
            opacity: 1;
            pointer-events: auto
        }

        #iframe-layer iframe {
            width: 100%;
            height: 100%;
            border: none
        }

        .connecting-overlay {
            position: fixed;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, #0f172a 0%, #020617 100%);
            transition: opacity 0.6s ease
        }

        .connecting-overlay.hidden {
            opacity: 0;
            pointer-events: none
        }

        .connecting-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(52, 211, 153, 0.2);
            border-top-color: #34d399;
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .connecting-text {
            margin-top: 1rem;
            color: #94a3b8;
            font-family: system-ui, sans-serif;
            font-size: 0.9rem;
            font-weight: 500
        }

        .mode-indicator {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            color: #64748b;
            font-family: monospace;
            font-size: 0.65rem;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s
        }

        body:hover .mode-indicator {
            opacity: 1
        }
    </style>
</head>

<body>
    <div class="connecting-overlay" id="connecting">
        <div class="connecting-spinner"></div>
        <div class="connecting-text">Conectando al panel…</div>
    </div>

    <div class="mode-indicator" id="mode-indicator">SLIDES</div>

    <div class="layer" id="slide-layer">
        <img id="slide-img" src="/presentation/Slide1.PNG" alt="Slide">
    </div>

    <div class="layer" id="iframe-layer">
        <iframe id="demo-iframe" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
            loading="lazy"></iframe>
    </div>

    <script th:inline="javascript">
        const totalSlides = /*[[${totalSlides}]]*/ 11;
        let currentSlide = 1;
        let demoActive = false;
        let demoUrl = '';
        let connected = false;

        const slideImg = document.getElementById('slide-img');
        const iframeLayer = document.getElementById('iframe-layer');
        const demoIframe = document.getElementById('demo-iframe');
        const modeIndicator = document.getElementById('mode-indicator');
        const connectingOverlay = document.getElementById('connecting');

        function updateSlideView() {
            slideImg.src = `/presentation/Slide${currentSlide}.PNG`;
        }

        function setMode(isDemo, url) {
            if (isDemo && url) {
                iframeLayer.classList.add('active');
                if (demoIframe.src !== url) demoIframe.src = url;
                modeIndicator.textContent = 'DEMO';
                modeIndicator.style.color = '#f43f5e';
            } else {
                iframeLayer.classList.remove('active');
                demoIframe.src = 'about:blank';
                modeIndicator.textContent = 'SLIDES';
                modeIndicator.style.color = '#64748b';
            }
        }

        async function pollState() {
            try {
                const [slideRes, demoRes] = await Promise.all([
                    fetch('/api/slide').then(r => r.json()),
                    fetch('/api/demo').then(r => r.json())
                ]);

                if (!connected) {
                    connected = true;
                    connectingOverlay.classList.add('hidden');
                }

                if (slideRes.slide !== currentSlide) {
                    currentSlide = slideRes.slide;
                    updateSlideView();
                }

                const newDemoActive = demoRes.active || false;
                const newDemoUrl = demoRes.url || '';

                if (newDemoActive !== demoActive || newDemoUrl !== demoUrl) {
                    demoActive = newDemoActive;
                    demoUrl = newDemoUrl;
                    setMode(demoActive, demoUrl);
                }
            } catch (e) {
                if (connected) {
                    connected = false;
                    connectingOverlay.classList.remove('hidden');
                }
            }
        }

        // Initial poll + interval
        pollState();
        setInterval(pollState, 1200);

        // Keyboard backup controls
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowRight') {
                const n = Math.min(currentSlide + 1, totalSlides);
                fetch('/api/slide', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slide: n }) });
            } else if (e.key === 'ArrowLeft') {
                const n = Math.max(currentSlide - 1, 1);
                fetch('/api/slide', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slide: n }) });
            } else if (e.key === 'Escape') {
                fetch('/api/demo', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: '', active: false }) });
            }
        });
    </script>
</body>

</html>