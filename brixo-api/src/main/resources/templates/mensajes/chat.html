<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layouts/main}">
<head><title>Chat - Brixo</title>
<style>
    .chat-container { height:60vh; overflow-y:auto; background:#f8f9fa; border-radius:16px; padding:20px; }
    .msg-bubble { max-width:70%; padding:12px 16px; border-radius:16px; margin-bottom:8px; }
    .msg-mine { background:var(--primary-color,#009fd9); color:#fff; margin-left:auto; border-bottom-right-radius:4px; }
    .msg-other { background:#fff; border:1px solid #e5e7eb; border-bottom-left-radius:4px; }
    .msg-time { font-size:.75rem; opacity:.7; }
</style>
</head>
<body>
<main layout:fragment="content">
    <div class="container py-4" style="max-width:800px;">
        <div class="d-flex align-items-center gap-3 mb-4">
            <a th:href="@{/mensajes}" class="btn btn-outline-secondary rounded-circle"><i class="fas fa-arrow-left"></i></a>
            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center"
                 style="width:44px;height:44px;"><i class="fas fa-user text-primary"></i></div>
            <h4 class="fw-bold mb-0" th:text="${otroNombre}">Contacto</h4>
        </div>

        <!-- Messages -->
        <div class="chat-container" id="chatContainer">
            <div th:each="m : ${mensajes}" th:classappend="${m.esMio} ? 'd-flex justify-content-end' : 'd-flex justify-content-start'">
                <div th:classappend="${m.esMio} ? 'msg-bubble msg-mine' : 'msg-bubble msg-other'">
                    <div th:text="${m.contenido}">Mensaje</div>
                    <div class="msg-time text-end" th:text="${m.fecha}">12:00</div>
                </div>
            </div>
        </div>

        <!-- Send -->
        <form id="sendForm" class="mt-3">
            <div class="input-group">
                <input type="text" class="form-control form-control-lg rounded-start-pill" id="msgInput"
                       placeholder="Escribe un mensaje..." autocomplete="off">
                <button class="btn btn-primary rounded-end-pill px-4" type="submit"><i class="fas fa-paper-plane"></i></button>
            </div>
            <input type="hidden" id="otroId" th:value="${otroId}">
            <input type="hidden" id="otroRol" th:value="${otroRol}">
        </form>
    </div>
</main>

<th:block layout:fragment="scripts">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('chatContainer');
    container.scrollTop = container.scrollHeight;

    const form = document.getElementById('sendForm');
    const input = document.getElementById('msgInput');
    const otroId = document.getElementById('otroId').value;
    const otroRol = document.getElementById('otroRol').value;

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const contenido = input.value.trim();
        if(!contenido) return;

        fetch('/mensajes/enviar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ destinatarioId: otroId, destinatarioRol: otroRol, contenido: contenido })
        }).then(r => r.json()).then(data => {
            const div = document.createElement('div');
            div.className = 'd-flex justify-content-end';
            div.innerHTML = '<div class="msg-bubble msg-mine"><div>'+contenido+'</div><div class="msg-time text-end">Ahora</div></div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            input.value = '';
        });
    });

    // Polling for new messages
    setInterval(function() {
        fetch('/mensajes/nuevos/'+otroId+'/'+otroRol)
            .then(r => r.json())
            .then(msgs => {
                msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'd-flex justify-content-start';
                    div.innerHTML = '<div class="msg-bubble msg-other"><div>'+m.contenido+'</div><div class="msg-time">'+m.fecha+'</div></div>';
                    container.appendChild(div);
                });
                if(msgs.length) container.scrollTop = container.scrollHeight;
            });
    }, 5000);
});
</script>
</th:block>
</body>
</html>
