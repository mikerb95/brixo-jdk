<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<div th:fragment="modals">

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 rounded-4 shadow">
            <div class="modal-header border-0 p-0 mb-4">
                <h2 class="modal-title fs-4 fw-bold" id="loginModalLabel">Iniciar sesión</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div th:if="${loginError}" class="alert alert-danger mb-4" th:text="${loginError}"></div>
                <form method="post" th:action="@{/login}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="mb-3">
                        <label for="login_correo" class="form-label fw-semibold">Correo electrónico</label>
                        <input id="login_correo" name="correo" type="email" class="form-control p-3 rounded-3"
                               placeholder="nombre@ejemplo.com" required>
                    </div>
                    <div class="mb-4">
                        <label for="login_contrasena" class="form-label fw-semibold">Contraseña</label>
                        <input id="login_contrasena" name="contrasena" type="password"
                               class="form-control p-3 rounded-3" placeholder="Tu contraseña" required>
                        <div class="text-end mt-2">
                            <a th:href="@{/password/forgot}" class="text-muted text-decoration-none small">
                                <i class="fas fa-key me-1"></i>¿Olvidaste tu contraseña?
                            </a>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-3 fw-bold">Entrar</button>
                    <div class="text-center mt-3">
                        <small class="text-muted">¿No tienes una cuenta?
                            <a href="#" class="text-primary fw-bold text-decoration-none"
                               data-bs-toggle="modal" data-bs-target="#registerModal">Regístrate</a>
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 rounded-4 shadow">
            <div class="modal-header border-0 p-0 mb-4">
                <h2 class="modal-title fs-4 fw-bold" id="registerModalLabel">Crear cuenta</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div th:if="${registerError}" class="alert alert-danger mb-4" th:text="${registerError}"></div>
                <form method="post" th:action="@{/register}" id="registerForm" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="action" value="register">
                    <div class="mb-3">
                        <label for="registro_nombre" class="form-label fw-semibold">Nombre</label>
                        <input id="registro_nombre" name="nombre" type="text" class="form-control p-3 rounded-3"
                               placeholder="Tu nombre"
                               th:value="${registerOld != null ? registerOld.nombre : ''}" required>
                    </div>
                    <div class="mb-3">
                        <label for="registro_foto" class="form-label fw-semibold">Foto de Perfil (Opcional)</label>
                        <input id="registro_foto" name="foto_perfil" type="file" class="form-control p-3 rounded-3"
                               accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="registro_correo" class="form-label fw-semibold">Correo electrónico</label>
                        <input id="registro_correo" name="correo" type="email" class="form-control p-3 rounded-3"
                               placeholder="nombre@ejemplo.com"
                               th:value="${registerOld != null ? registerOld.correo : ''}" required>
                    </div>
                    <div class="mb-3">
                        <label for="registro_telefono" class="form-label fw-semibold">Teléfono</label>
                        <input id="registro_telefono" name="telefono" type="tel" class="form-control p-3 rounded-3"
                               placeholder="3101234567"
                               th:value="${registerOld != null ? registerOld.telefono : ''}">
                    </div>
                    <div class="mb-3">
                        <label for="registro_contrasena" class="form-label fw-semibold">Contraseña</label>
                        <input id="registro_contrasena" name="contrasena" type="password"
                               class="form-control p-3 rounded-3" placeholder="Crea una contraseña" required>
                    </div>
                    <div class="mb-3">
                        <label for="registro_contrasena_confirm" class="form-label fw-semibold">Confirmar contraseña</label>
                        <input id="registro_contrasena_confirm" name="contrasena_confirm" type="password"
                               class="form-control p-3 rounded-3" placeholder="Repite la contraseña" required>
                    </div>
                    <div class="mb-3">
                        <label for="registro_rol" class="form-label fw-semibold">Tipo de cuenta</label>
                        <select id="registro_rol" name="rol" class="form-select p-3 rounded-3" required>
                            <option value="cliente"
                                    th:selected="${registerOld != null and registerOld.rol == 'cliente'}">Cliente</option>
                            <option value="contratista"
                                    th:selected="${registerOld != null and registerOld.rol == 'contratista'}">Contratista</option>
                        </select>
                    </div>

                    <!-- Location Fields -->
                    <div class="mb-3">
                        <label for="registro_departamento" class="form-label fw-semibold">Departamento</label>
                        <select id="registro_departamento" class="form-select p-3 rounded-3" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="registro_ciudad" class="form-label fw-semibold">Ciudad</label>
                        <select id="registro_ciudad" name="ciudad" class="form-select p-3 rounded-3" disabled required></select>
                    </div>

                    <div id="contractorFields" class="mb-3 d-none"
                         th:classappend="${registerOld != null and registerOld.rol == 'contratista'} ? '' : 'd-none'">
                        <div class="mb-3">
                            <label for="registro_ubicacion" class="form-label fw-semibold">Ubicación exacta</label>
                            <div id="mapaRegistro" style="height: 300px; width: 100%; border-radius: 10px; margin-bottom: 10px;"></div>
                            <input id="registro_ubicacion" name="ubicacion_mapa" type="text"
                                   class="form-control p-3 rounded-3" placeholder="Selecciona en el mapa"
                                   th:value="${registerOld != null ? registerOld.ubicacionMapa : ''}" readonly>
                            <small class="text-muted">Arrastra el marcador azul para indicar tu ubicación.</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-3 fw-bold">Registrarme</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Dependencies for Modals -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script th:src="@{/js/colombia-locations.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const roleSelect = document.getElementById('registro_rol');
        const contractorFields = document.getElementById('contractorFields');
        const deptInput = document.getElementById('registro_departamento');
        const cityInput = document.getElementById('registro_ciudad');
        const mapInput = document.getElementById('registro_ubicacion');

        const oldCity = /*[[${registerOld != null ? registerOld.ciudad : ''}]]*/ '';
        if (typeof initColombiaSelects === 'function') {
            initColombiaSelects('registro_departamento', 'registro_ciudad', oldCity);
        }

        let map = null;
        let marker = null;

        const initMap = () => {
            if (map) return;
            const defaultLat = 4.6097;
            const defaultLng = -74.0817;

            map = L.map('mapaRegistro').setView([defaultLat, defaultLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

            marker.on('dragend', function (event) {
                const position = marker.getLatLng();
                mapInput.value = position.lat + ',' + position.lng;
            });

            map.on('click', function (e) {
                marker.setLatLng(e.latlng);
                mapInput.value = e.latlng.lat + ',' + e.latlng.lng;
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const newLatLng = new L.LatLng(lat, lng);
                    marker.setLatLng(newLatLng);
                    map.setView(newLatLng, 15);
                    mapInput.value = lat + ',' + lng;
                });
            }

            if (mapInput.value) {
                const parts = mapInput.value.split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lng = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const savedLatLng = new L.LatLng(lat, lng);
                        marker.setLatLng(savedLatLng);
                        map.setView(savedLatLng, 15);
                    }
                }
            }
        };

        const toggleContractorFields = () => {
            const isContractor = roleSelect.value === 'contratista';
            contractorFields.classList.toggle('d-none', !isContractor);
            if (mapInput) mapInput.required = isContractor;
            if (isContractor) {
                setTimeout(() => {
                    initMap();
                    if (map) map.invalidateSize();
                }, 200);
            }
        };

        if (roleSelect && contractorFields && cityInput && mapInput) {
            roleSelect.addEventListener('change', toggleContractorFields);
            if (roleSelect.value === 'contratista') {
                toggleContractorFields();
            }
        }

        const registerModalEl = document.getElementById('registerModal');
        if (registerModalEl) {
            registerModalEl.addEventListener('shown.bs.modal', function () {
                if (roleSelect.value === 'contratista' && map) {
                    map.invalidateSize();
                }
            });
        }
    });
</script>

</div>
</body>
</html>
